###############################################################################
# MERCADO NO LIBRE - ARCHIVO DE PRUEBA COMPLETO Y FUNCIONAL
# Para usar con la extensi√≥n "REST Client" de VS Code
# Ejecutar en orden: cada request usa variables de requests anteriores
###############################################################################

# CONFIGURACI√ìN BASE
@host = http://localhost:4000
@baseUrl = {{host}}/api
@contentType = application/json

# NOTA: Estas variables se actualizar√°n autom√°ticamente al ejecutar cada request
# Si alguna variable no se captura, c√≥piala manualmente desde la respuesta


###############################################################################
# 1. üè† HEALTH CHECK
###############################################################################

### 1.1 Verificar que el servidor est√© corriendo
GET {{host}}/
Accept: application/json


###############################################################################
# 2. üîê REGISTRO DE USUARIOS
###############################################################################

### 2.1 Registrar COMPRADOR
# @name registerComprador
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "comprador_test",
  "email": "comprador.flow@test.com",
  "password": "password123",
  "role": "comprador"
}

###

### 2.2 Registrar VENDEDOR
# @name registerVendedor
POST {{baseUrl}}/auth/register
Content-Type: {{contentType}}

{
  "username": "vendedor_test",
  "email": "vendedor.flow@test.com",
  "password": "password123",
  "role": "vendedor"
}


###############################################################################
# 3. üîë LOGIN DE USUARIOS
###############################################################################

### 3.1 Login VENDEDOR
# @name loginVendedor
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "vendedor.flow@test.com",
  "password": "password123"
}

###

### 3.2 Login COMPRADOR
# @name loginComprador
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "comprador.flow@test.com",
  "password": "password123"
}


###############################################################################
# 4. üë§ PERFIL DE USUARIO
###############################################################################

### 4.1 Obtener perfil del VENDEDOR (usa token del login)
GET {{baseUrl}}/auth/me
Authorization: Bearer {{loginVendedor.response.body.data.token}}

###

### 4.2 Obtener perfil del COMPRADOR
GET {{baseUrl}}/auth/me
Authorization: Bearer {{loginComprador.response.body.data.token}}


###############################################################################
# 5. üë• GESTI√ìN DE USUARIOS
###############################################################################

### 5.1 Listar todos los usuarios (requiere autenticaci√≥n)
GET {{baseUrl}}/users?page=1&limit=10
Authorization: Bearer {{loginComprador.response.body.data.token}}

###

### 5.2 Buscar usuarios por nombre
GET {{baseUrl}}/users?search=test&page=1&limit=5
Authorization: Bearer {{loginComprador.response.body.data.token}}


###############################################################################
# 6. üì¶ PRODUCTOS - CREAR
###############################################################################

### 6.1 Crear Producto 1 (Laptop)
# @name createProduct1
POST {{baseUrl}}/products
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "name": "Laptop Gamer Essential",
  "description": "Port√°til robusta para gaming casual y trabajo diario. Procesador Intel i5, 16GB RAM, SSD 512GB.",
  "price": 899.50,
  "category": "Electr√≥nica",
  "stock": 15,
  "image": "https://via.placeholder.com/400x300?text=Laptop+Gamer"
}

###

### 6.2 Crear Producto 2 (Mouse)
# @name createProduct2
POST {{baseUrl}}/products
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "name": "Mouse Inal√°mbrico RGB",
  "description": "Mouse gaming con iluminaci√≥n RGB y sensor √≥ptico de alta precisi√≥n. Ideal para gamers.",
  "price": 45.99,
  "category": "Electr√≥nica",
  "stock": 50,
  "image": "https://via.placeholder.com/400x300?text=Mouse+RGB"
}

###

### 6.3 Crear Producto 3 (Teclado)
# @name createProduct3
POST {{baseUrl}}/products
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "name": "Teclado Mec√°nico RGB",
  "description": "Teclado mec√°nico con switches azules, retroiluminaci√≥n RGB y reposamu√±ecas acolchado.",
  "price": 129.99,
  "category": "Electr√≥nica",
  "stock": 30,
  "image": "https://via.placeholder.com/400x300?text=Teclado+Mecanico"
}


###############################################################################
# 7. üì¶ PRODUCTOS - CONSULTAR
###############################################################################

### 7.1 Obtener TODOS los productos (p√∫blico)
GET {{baseUrl}}/products?page=1&limit=10

###

### 7.2 Buscar productos por nombre
GET {{baseUrl}}/products?search=Laptop&page=1&limit=5

###

### 7.3 Filtrar por categor√≠a
GET {{baseUrl}}/products?category=Electr√≥nica&page=1&limit=10

###

### 7.4 Filtrar por rango de precio
GET {{baseUrl}}/products?minPrice=40&maxPrice=100

###

### 7.5 Obtener UN producto espec√≠fico
GET {{baseUrl}}/products/{{createProduct1.response.body.data._id}}

###

### 7.6 Obtener productos del vendedor
GET {{baseUrl}}/products/seller/{{loginVendedor.response.body.data.user._id}}


###############################################################################
# 8. üì¶ PRODUCTOS - ACTUALIZAR
###############################################################################

### 8.1 Actualizar precio y stock del producto 1
# @name updateProduct1
PUT {{baseUrl}}/products/{{createProduct1.response.body.data._id}}
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "price": 799.00,
  "stock": 10,
  "description": "Port√°til robusta para gaming casual y trabajo diario. ¬°OFERTA ESPECIAL! Procesador Intel i5, 16GB RAM, SSD 512GB."
}

###

### 8.2 Actualizar solo el stock del producto 2
PUT {{baseUrl}}/products/{{createProduct2.response.body.data._id}}
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "stock": 45
}


###############################################################################
# 9. üí¨ CONVERSACIONES - CREAR
###############################################################################

### 9.1 Comprador inicia conversaci√≥n sobre Laptop
# @name createConversation1
POST {{baseUrl}}/conversations
Authorization: Bearer {{loginComprador.response.body.data.token}}
Content-Type: {{contentType}}

{
  "participantId": {{loginVendedor.response.body.data.user._id}},
  "productId": {{createProduct1.response.body.data._id}}
}

###

### 9.2 Comprador inicia conversaci√≥n sobre Mouse
# @name createConversation2
POST {{baseUrl}}/conversations
Authorization: Bearer {{loginComprador.response.body.data.token}}
Content-Type: {{contentType}}

{
  "participantId": {{loginVendedor.response.body.data.user._id}},
  "productId": {{createProduct2.response.body.data._id}}
}


###############################################################################
# 10. üí¨ CONVERSACIONES - CONSULTAR
###############################################################################

### 10.1 Obtener TODAS las conversaciones del comprador
GET {{baseUrl}}/conversations
Authorization: Bearer {{loginComprador.response.body.data.token}}

###

### 10.2 Obtener TODAS las conversaciones del vendedor
GET {{baseUrl}}/conversations
Authorization: Bearer {{loginVendedor.response.body.data.token}}

###

### 10.3 Obtener conversaci√≥n espec√≠fica
GET {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}
Authorization: Bearer {{loginComprador.response.body.data.token}}


###############################################################################
# 11. üí¨ MENSAJES - ENVIAR
###############################################################################

### 11.1 Comprador env√≠a mensaje inicial
# @name sendMessage1
POST {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}/messages
Authorization: Bearer {{loginComprador.response.body.data.token}}
Content-Type: {{contentType}}

{
  "content": "Hola, estoy interesado en la laptop. ¬øEst√° disponible todav√≠a?"
}

###

### 11.2 Vendedor responde
# @name sendMessage2
POST {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}/messages
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "content": "¬°Hola! S√≠, a√∫n tenemos stock. Actualmente est√° en oferta a $799."
}

###

### 11.3 Comprador pregunta sobre precio
# @name sendMessage3
POST {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}/messages
Authorization: Bearer {{loginComprador.response.body.data.token}}
Content-Type: {{contentType}}

{
  "content": "¬øEl precio es negociable si compro dos unidades?"
}

###

### 11.4 Vendedor negocia
# @name sendMessage4
POST {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}/messages
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "content": "Por dos unidades te puedo hacer $750 cada una. ¬øTe parece bien?"
}

###

### 11.5 Comprador acepta
POST {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}/messages
Authorization: Bearer {{loginComprador.response.body.data.token}}
Content-Type: {{contentType}}

{
  "content": "¬°Perfecto! Me interesa. ¬øC√≥mo procedo con la compra?"
}


###############################################################################
# 12. üí¨ MENSAJES - CONSULTAR
###############################################################################

### 12.1 Obtener mensajes de la conversaci√≥n
GET {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}/messages?page=1&limit=50
Authorization: Bearer {{loginComprador.response.body.data.token}}

###

### 12.2 Marcar mensajes como le√≠dos
PUT {{baseUrl}}/conversations/{{createConversation1.response.body.data._id}}/messages/read
Authorization: Bearer {{loginComprador.response.body.data.token}}


###############################################################################
# 13. üîÑ ACTUALIZAR PERFIL
###############################################################################

### 13.1 Actualizar perfil del comprador
PUT {{baseUrl}}/users/{{loginComprador.response.body.data.user._id}}
Authorization: Bearer {{loginComprador.response.body.data.token}}
Content-Type: {{contentType}}

{
  "username": "comprador_actualizado",
  "email": "comprador.flow@test.com"
}


###############################################################################
# 14. üóëÔ∏è LIMPIEZA (SOFT DELETES)
###############################################################################

### 14.1 Eliminar producto 3 (soft delete)
DELETE {{baseUrl}}/products/{{createProduct3.response.body.data._id}}
Authorization: Bearer {{loginVendedor.response.body.data.token}}

###

### 14.2 Eliminar conversaci√≥n 2
DELETE {{baseUrl}}/conversations/{{createConversation2.response.body.data._id}}
Authorization: Bearer {{loginComprador.response.body.data.token}}

###

### 14.3 Desactivar cuenta del comprador (soft delete)
DELETE {{baseUrl}}/users/{{loginComprador.response.body.data.user._id}}
Authorization: Bearer {{loginComprador.response.body.data.token}}


###############################################################################
# 15. ‚úÖ VERIFICACI√ìN FINAL
###############################################################################

### 15.1 Verificar que el producto 3 ya no aparece
GET {{baseUrl}}/products

###

### 15.2 Verificar productos del vendedor (solo deben aparecer 2)
GET {{baseUrl}}/products/seller/{{loginVendedor.response.body.data.user._id}}

###

### 15.3 Intentar login con cuenta desactivada (debe fallar)
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
  "email": "comprador.flow@test.com",
  "password": "password123"
}


###############################################################################
# 16. üß™ PRUEBAS DE VALIDACI√ìN
###############################################################################

### 16.1 Intentar crear producto SIN autenticaci√≥n (debe fallar)
POST {{baseUrl}}/products
Content-Type: {{contentType}}

{
  "name": "Producto sin auth",
  "description": "Este producto no deber√≠a crearse",
  "price": 100,
  "category": "Otros",
  "stock": 5
}

###

### 16.2 Intentar crear producto con precio inv√°lido (debe fallar)
POST {{baseUrl}}/products
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "name": "Producto precio inv√°lido",
  "description": "Descripci√≥n v√°lida de al menos 10 caracteres",
  "price": -50,
  "category": "Otros",
  "stock": 5
}

###

### 16.3 Intentar enviar mensaje a conversaci√≥n que no existe (debe fallar)
POST {{baseUrl}}/conversations/99999/messages
Authorization: Bearer {{loginVendedor.response.body.data.token}}
Content-Type: {{contentType}}

{
  "content": "Este mensaje no deber√≠a enviarse"
}


###############################################################################
# NOTAS DE USO:
# 
# 1. Instala la extensi√≥n "REST Client" en VS Code
# 2. Abre este archivo en VS Code
# 3. Haz clic en "Send Request" sobre cada ### para ejecutar
# 4. Las variables se capturan autom√°ticamente entre requests
# 5. Si una variable no se captura, c√≥piala manualmente desde la respuesta
# 6. Ejecuta las requests EN ORDEN para que funcione el flujo completo
# 
# SHORTCUTS:
# - Ctrl+Alt+R (Windows/Linux) o Cmd+Alt+R (Mac): Enviar request
# - Ctrl+Alt+C (Windows/Linux) o Cmd+Alt+C (Mac): Cancelar request
# - Ctrl+Alt+K (Windows/Linux) o Cmd+Alt+K (Mac): Ver historial
###############################################################################
